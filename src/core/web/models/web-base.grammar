start Web

Web ::= [Web] toplevels:Toplevel*

Toplevel ::= [Def] "def" name:sym Sig? body:Stat
	  |  [Import] "import" module:sym

// TODO: we have a dangling else problem...

Stat ::= [For] "for" "(" var:sym ":" iter:Exp Index? ")" body:Stat
       | [If] "if" "(" cond:Exp ")" body:Stat ("else" else:Stat)?
       | [Call] exp:Primary Args? block:Block
       | Call ";"  // todo: should be exp if we have closures
       | Block
       | [Let] "let" decls:Assign* "in" body:Stat
       | [Output] "$" exp:Exp
       | [Text] value:str
       | [Switch] "switch" "(" exp:Exp ")" "{" cases:Case*
       	 	  	   ("default" default:Stat)? "}"
       | [Do] "do" call:Exp ";"
       | [Do] "doif" cond:Exp call:Exp ";"

Block ::= [Block] "{" stats:Stat* "}"

Call ::= [Call] exp:Primary Args

Case ::= [Case] "case" name:sym ":" body:Stat



Primary ::= [Field] exp:Primary "->" name:sym
      | [Subscript] obj:Primary "[" exp:Exp "]"
      | [Var] name:sym


Exp ::= Primary
      | [Str] value:str
      | [Int] value:int
      | Call  
      | [New] "new" "(" class:sym ")"
      | [Address] "address" "(" exp:Exp ")"
      | [Concat] lhs:Exp "+" rhs:Exp  // TODO: precedences
      | [Equal] lhs:Exp "==" rhs:Exp 
      | [In] lhs:Exp "in" rhs:Exp 
      | [List] "[" elements:{Exp ","}* "]"

      
Index ::= "," index:sym

Assign ::= [Assign] name:sym "=" exp:Exp

Args ::= "(" args:{Exp ","}* ")"

Sig ::=  "(" Formals  ")"

Formals ::= formals:{Formal ","}+ "," tail:Tail
         |  formals:{Formal ","}* 
         |  tail:Tail

Tail ::= [Tail] name:sym "[" Formals "]"

// TODO: only allow Cons in tail positions
// we cannot have tail args and cons args at 
// the same time
//    |  [Cons] name:sym ":" cons:sym Sig
Formal ::= [Formal] name:sym (":" cons:Cons)?

Cons ::= [Cons] name:sym Sig

