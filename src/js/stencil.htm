<!DOCTYPE html>
<html>
    <head>
        <title>My Sample Project</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->
        <script src="jquery.js"></script>
        <script src="require.js"></script>
     <script>
requirejs([
  "enso",
'core/system/load/load',
'core/diagram/code/construct',
'core/diagram/code/render'
],
function(Enso, Load, Construct, Render) {
// jquery
data_file = "income.ql"
stencil_file = S("ql.stencil")

stencil = Load.load(stencil_file)
data = Load.load(data_file)
params = new EnsoHash({ data:  data })
diagram = Construct.eval(stencil, params)
//html = Render.render(diagram, params)
//console.log("FOO");

function getMethods(obj) {
  var result = [];
  for (var id in obj) {
    try {
      if (typeof(obj[id]) == "function") {
        result.push(id + ": " + obj[id].toString());
      }
    } catch (err) {
      result.push(id + ": inaccessible");
    }
  }
  return result;
}

var interp = { 
  render: function(obj) {
    var self = this; 
	type = obj.schema_class();
    method = S("render", "_", type.name()).to_s();
    console.log(S("this method is ", method));
    result = this[method](obj);
    return result;
  },
  render_Stencil: function (obj) {
  	return this.render(obj.body())
  },
  render_Shape: function (obj) {
  	if (obj.content()) {
	  return this.render(obj.content());
  	} else {
      return document.createElement("p");
  	}
  },
  render_Container: function (obj) {
  	console.log("blah cont")
  	var dom = $('<table>')
  	this.make_style(dom, obj.props());
  	if (obj.direction()==1) { //vertical
	    for (var i=0,len=obj.items().size(); i<len; i++)
	    {
	    	t = this.render(obj.items()._get(i));
	    	row = $('<tr border="1">');
	    	row.append(t);
	    	dom.append(row);
	  	} 
  	} else if (obj.direction()==2) { //horizontal
	     var row = $("<tr>");
	    for (var i=0,len=obj.items().size(); i<len; i++)
	    {
	    	t = this.render(obj.items()._get(i));
	    	col = $("<td>");
	    	col.append(t);
	    	row.append(col);
	  	} 
	    dom.append(row);
  	}
    return dom;
  },
  render_Pages: function (obj) {
  	console.log("blah pages")
  	var dom = $("<p />")
  	this.make_style(dom, obj.props());
    for (var i=0,len=obj.items().size(); i<len; i++)
    {
    	t = this.render(obj.items()._get(i));
    	t.appendTo(dom);
    }
    return dom;
  },
  render_Space: function (obj) {
  	var txt3 = $("<p>");
  	return txt3;
  },
  render_Text: function (obj) {
  	console.log("blah text")
  	var dom = $('<text>');
  	this.make_style(dom, obj.props());
  	dom.text(obj.string().val().to_s());
    return dom;
  },
  render_TextBox: function (obj) {
  	console.log("blah textbx")
  	var dom = $("<input type='text'>");
  	this.make_style(dom, obj.props());
  	dom.keyup(function () {
		var value = parseInt($(this).val());
		if (value) {
			if (obj.value()._get('val')!=value) {
				obj.value()._set('val', value);
			}
		}
	}).keyup();
  	dom.val(obj.value().val().to_s()); 
    return dom;
  },
  render_CheckBox: function (obj) {
  	console.log("blah chkbx")
  	var dom = $("<input type='checkbox'>");
  	this.make_style(dom, obj.props);
  	var li = $("<li>asd</li>");
  	dom.append(li);
    return dom;
  },
  render_RadioList: function (obj) {
  	console.log("blah radbx")
  	var dom = $('<form>');
  	this.make_style(dom, obj.props());
    for (var i=0,len=obj.choices().size(); i<len; i++)
    {
    	var choice = obj.choices()._get(i);
    	var line = S("<input type='radio'>", choice.val(), "</input>");
    	var arrange = obj.props._get("arrange");
    	console.log(obj.props._get("arrange"));
    	if (arrange=='vertical') {
    		line = line + "<br>";
    	} else if (arrange=='horizontal') {
    	} else {
    		//automatically determine how to arrange
    	}
        dom.append($(line));
    }
    return dom;
  },
  coercetostr: function () { },
  coercefromstr: function () { },
  make_style: function (dom, props) {
  	props.each(function(prop) {
      dom.css(prop.var().to_s(), prop.val().val().to_s());
    });
  },
}
   data = interp.render(diagram)
   $("body").append(data);
}
)
</script>
    </head>
    <body>
</html>
